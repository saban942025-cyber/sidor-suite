<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sidor | פורטל לקוחות</title>
    
    <!-- טעינת ספריות -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- שימוש ב-Babel 7 החדש התומך ב-ES Modules -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide לא נחוץ כאן כי אנו משתמשים באייקונים מוטמעים (SVG) -->
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; overscroll-behavior: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- שימוש ב-data-type="module" חשוב כדי למנוע שגיאת require -->
    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef, useMemo } = React;
        const { createRoot } = ReactDOM;
        
        // --- Firebase Imports (ES Modules) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, query, orderBy, where, getDoc, addDoc, serverTimestamp, limit, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
          authDomain: "saban94-78949.firebaseapp.com", 
          projectId: "saban94-78949",
          storageBucket: "saban94-78949.firebasestorage.app",
          messagingSenderId: "41553157903", 
          appId: "1:41553157903:web:cc33d252cff023be97a87a",
          measurementId: "G-XV6RZDESSB"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- אייקונים (SVG) ---
        const Icon = ({ name, className }) => {
            if (name === 'MessageSquare') return <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>;
            if (name === 'BookOpen') return <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>;
            if (name === 'User') return <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
            if (name === 'LogOut') return <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>;
            if (name === 'ArrowRight') return <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>;
            if (name === 'Send') return <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>;
            if (name === 'Search') return <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>;
            return null;
        };

        // --- קטלוג מוצרים (Hardcoded) ---
        const KnowledgeBase = {
            products: [
                { id: "p-101", sku: "10-101", name: "לוח גבס לבן (סטנדרטי)", image: "https://placehold.co/100x100/e0e7ff/3730a3?text=Gevs", spec: "120x260", description: "לוח סטנדרטי לקירות." },
                { id: "p-102", sku: "10-102", name: "ניצב 70 מ\"מ", image: "https://placehold.co/100x100/e0e7ff/3730a3?text=Nitzav", spec: "300 סמ", description: "פרופיל אנכי." },
                { id: "p-103", sku: "10-103", name: "מסלול 70 מ\"מ", image: "https://placehold.co/100x100/e0e7ff/3730a3?text=Maslul", spec: "300 סמ", description: "מסילה לרצפה/תקרה." }
            ],
            search: function(term) {
                if (term.length < 2) return [];
                return this.products.filter(p => p.name.includes(term) || p.sku.includes(term));
            }
        };

        // --- קומפוננטות ---

        function AuthScreen() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true); setError('');
                try { await signInWithEmailAndPassword(auth, email, password); } 
                catch (err) { setError("פרטי התחברות שגויים."); }
                setLoading(false);
            };

            return (
                <div className="flex items-center justify-center min-h-screen bg-gray-100 p-4">
                    <div className="w-full max-w-md bg-white p-8 rounded-2xl shadow-lg">
                        <h2 className="text-2xl font-bold text-center text-blue-600 mb-6">Sidor Customer</h2>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input type="email" placeholder="אימייל" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-3 border rounded-lg" required />
                            <input type="password" placeholder="סיסמה" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-3 border rounded-lg" required />
                            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                            <button disabled={loading} className="w-full p-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">{loading ? "מתחבר..." : "כניסה"}</button>
                        </form>
                    </div>
                </div>
            );
        }

        function ChatList({ profile, onSelect }) {
            // בדיקה בטוחה למניעת קריסה אם profile ריק
            const projects = (profile && profile.projects) ? profile.projects : [];
            
            return (
                <div className="flex flex-col h-full">
                    <header className="p-4 bg-white shadow-sm sticky top-0 z-10">
                        <h1 className="text-2xl font-bold text-gray-800">הפרויקטים שלי</h1>
                    </header>
                    <div className="flex-1 overflow-y-auto p-2 space-y-2">
                        {projects.length === 0 && <p className="text-center text-gray-500 mt-10">אין פרויקטים משויכים.</p>}
                        {projects.map(p => (
                            <div key={p.projectId} onClick={() => onSelect(p)} className="flex items-center p-4 bg-white rounded-xl shadow-sm cursor-pointer hover:bg-gray-50">
                                <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-lg">{p.name.charAt(0)}</div>
                                <div className="mr-4 flex-1">
                                    <h3 className="font-bold text-gray-800">{p.name}</h3>
                                    <p className="text-sm text-gray-500">{p.address}</p>
                                </div>
                                <Icon name="ArrowRight" className="text-gray-300 w-5 h-5" />
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function ChatRoom({ project, user, onBack }) {
            const [messages, setMessages] = useState([]);
            const [text, setText] = useState('');
            const endRef = useRef(null);

            useEffect(() => {
                const q = query(collection(db, 'messages'), where('roomId', '==', project.projectId), orderBy('createdAt', 'asc'));
                const unsub = onSnapshot(q, snap => {
                    setMessages(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });
                return () => unsub();
            }, [project.projectId]);

            useEffect(() => {
                if (endRef.current) {
                    endRef.current.scrollIntoView({ behavior: 'smooth' });
                }
            }, [messages]);

            const sendMessage = async () => {
                if (!text.trim()) return;
                await addDoc(collection(db, 'messages'), {
                    roomId: project.projectId, senderId: user.uid, senderName: user.displayName || 'לקוח',
                    text: text.trim(), type: 'TEXT', createdAt: serverTimestamp(), replyTo: null
                });
                setText('');
            };

            return (
                <div className="flex flex-col h-full bg-[#e5ded8]">
                    <header className="bg-[#008069] text-white p-3 flex items-center shadow-md">
                        <button onClick={onBack} className="p-2"><Icon name="ArrowRight" className="w-6 h-6" /></button>
                        <div className="mr-3 font-bold text-lg">{project.name}</div>
                    </header>
                    
                    <div className="flex-1 overflow-y-auto p-4 space-y-2">
                        {messages.map(m => (
                            <div key={m.id} className={`flex ${m.senderId === user.uid ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[80%] p-2 rounded-lg shadow-sm text-sm ${m.senderId === user.uid ? 'bg-[#d9fdd3]' : 'bg-white'}`}>
                                    <div>{m.text}</div>
                                    <div className="text-[10px] text-gray-500 text-left mt-1">
                                        {m.createdAt ? new Date(m.createdAt.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...'}
                                    </div>
                                </div>
                            </div>
                        ))}
                        <div ref={endRef} />
                    </div>

                    <div className="p-2 bg-[#f0f2f5] flex items-center">
                        <input 
                            className="flex-1 mx-2 p-3 rounded-full border-none focus:ring-0 outline-none" 
                            placeholder="הודעה" 
                            value={text} 
                            onChange={e=>setText(e.target.value)} 
                            onKeyDown={e => e.key === 'Enter' && sendMessage()} 
                        />
                        <button onClick={sendMessage} className="p-3 bg-[#008069] text-white rounded-full">
                            <Icon name="Send" className="w-5 h-5" />
                        </button>
                    </div>
                </div>
            );
        }

        function KnowledgePage() {
            const [term, setTerm] = useState('');
            const results = term ? KnowledgeBase.search(term) : [];

            return (
                <div className="p-4 h-full flex flex-col">
                    <h2 className="text-2xl font-bold mb-4">קטלוג מוצרים</h2>
                    <div className="relative mb-4">
                        <input 
                            className="w-full p-3 pr-10 border rounded-lg" 
                            placeholder="חפש מוצר (למשל 'גבס')..." 
                            value={term} 
                            onChange={e=>setTerm(e.target.value)} 
                        />
                        <div className="absolute top-3 right-3 text-gray-400"><Icon name="Search" className="w-5 h-5" /></div>
                    </div>
                    <div className="flex-1 overflow-y-auto space-y-3">
                        {results.map(p => (
                            <div key={p.id} className="flex p-3 bg-white rounded-lg shadow-sm border">
                                <img src={p.image} className="w-16 h-16 object-cover rounded-md bg-gray-200" />
                                <div className="mr-3">
                                    <div className="font-bold text-blue-600">{p.name}</div>
                                    <div className="text-sm text-gray-600">{p.sku}</div>
                                    <div className="text-xs text-gray-400 mt-1">{p.spec}</div>
                                </div>
                            </div>
                        ))}
                        {term && results.length === 0 && <p className="text-center text-gray-500">לא נמצאו תוצאות</p>}
                    </div>
                </div>
            );
        }

        function App() {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeProject, setActiveProject] = useState(null);
            const [page, setPage] = useState('chats'); // chats, knowledge, profile

            useEffect(() => {
                const unsub = onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        const docRef = doc(db, 'customers', u.uid);
                        const snap = await getDoc(docRef);
                        if (snap.exists()) {
                            setUser(u);
                            setProfile({uid: u.uid, ...snap.data()});
                        } else {
                            console.error("No profile found for user:", u.uid);
                            signOut(auth);
                        }
                    } else { setUser(null); setProfile(null); }
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            if (loading) return <div className="flex h-screen items-center justify-center text-blue-600 font-bold">טוען...</div>;
            if (!user) return <AuthScreen />;

            if (activeProject) return <ChatRoom project={activeProject} user={user} onBack={() => setActiveProject(null)} />;

            return (
                <div className="flex flex-col h-screen bg-gray-50">
                    <div className="flex-1 overflow-hidden">
                        {page === 'chats' && <ChatList profile={profile} onSelect={setActiveProject} />}
                        {page === 'knowledge' && <KnowledgePage />}
                        {page === 'profile' && (
                            <div className="p-4 text-center">
                                <h2 className="text-xl font-bold">{profile && profile.name}</h2>
                                <p className="text-gray-500 mb-4">{profile && profile.email}</p>
                                <button onClick={()=>signOut(auth)} className="text-red-500 flex items-center justify-center mx-auto border border-red-200 p-2 rounded hover:bg-red-50">
                                    <Icon name="LogOut" className="mr-2 w-4 h-4"/> התנתק
                                </button>
                            </div>
                        )}
                    </div>
                    
                    <nav className="fixed bottom-0 w-full bg-white border-t flex justify-around p-2 pb-4 text-gray-500 z-20">
                        <button onClick={()=>setPage('chats')} className={`flex flex-col items-center ${page==='chats'?'text-blue-600':''}`}>
                            <Icon name="MessageSquare" className="w-6 h-6" /><span className="text-xs">שיחות</span>
                        </button>
                        <button onClick={()=>setPage('knowledge')} className={`flex flex-col items-center ${page==='knowledge'?'text-blue-600':''}`}>
                            <Icon name="BookOpen" className="w-6 h-6" /><span className="text-xs">קטלוג</span>
                        </button>
                        <button onClick={()=>setPage('profile')} className={`flex flex-col items-center ${page==='profile'?'text-blue-600':''}`}>
                            <Icon name="User" className="w-6 h-6" /><span className="text-xs">פרופיל</span>
                        </button>
                    </nav>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
